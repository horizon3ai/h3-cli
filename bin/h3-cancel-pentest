#!/bin/bash
#
# Simple shell script for canceling a pentest.
#

# 0.
# include common utils
source h3-env


# 1.
# read pentest either from args or from latest-pentest
pentest=`h3 pentest $*`
rc=$?
if [ $rc -ne 0 ]; then
    echo $pentest
    exit $rc
fi


# 2. 
# if the pentest is running, cancel it.
pentest_name=`cat <<<$pentest | jq -r .name`
pentest_state=`cat <<<$pentest | jq -r .state`
op_id=`cat <<<$pentest | jq -r .op_id`
if [ "$pentest_state" = "running" -o "$pentest_state" = "installation_needed" -o "$pentest_state" = "paused" ]; then
    res=`h3-gql cancel_op $op_id`
    rc=$?
    if [ $rc -eq 0 ]; then
        echoerr "Canceling pentest \"$pentest_name\" with op_id $op_id. It may take a few seconds to fully stop the pentest. The results will be processed and published to Portal."
    else
        echo $res
        exit $rc
    fi
else
    echoerr "Pentest \"$pentest_name\" with op_id $op_id is not in a cancelable state ($pentest_state)."
fi

