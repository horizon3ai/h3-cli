#!/bin/bash
#
# Simple shell script for pausing a pentest.
#

# 0.
# include common utils
source h3-env


# 1.
# read pentest either from args or from latest-pentest
pentest=`h3 pentest $*`
rc=$?
if [ $rc -ne 0 ]; then
    echo $pentest
    exit $rc
fi


# 2.
# if the pentest is done, download the reports zip
pentest_name=`cat <<<$pentest | jq -r .name`
pentest_state=`cat <<<$pentest | jq -r .state`
op_id=`cat <<<$pentest | jq -r .op_id`
if [ "$pentest_state" = "done" -o "$pentest_state" = "ended" ]; then
    url=`h3-gql pentest_reports_zip_url $op_id | jq -r .data.pentest_reports_zip_url`
    rc=$?
    if [ $rc -ne 0 ]; then
        echoerr "ERROR: Failed to download reports for pentest \"$pentest_name\" with op_id $op_id."
        exit $rc
    fi
    curl -x "$H3_CLI_PROXY_URL" -s -L -o pentest-reports-$op_id.zip "$url"
    rc=$?
    if [ $rc -ne 0 ]; then
        echoerr "ERROR: Failed to download reports for pentest \"$pentest_name\" with op_id $op_id."
        exit $rc
    fi
    echoerr "Downloaded reports for pentest \"$pentest_name\" to `pwd`/pentest-reports-$op_id.zip."
else
    echoerr "Pentest \"$pentest_name\" with op_id $op_id is not done yet ($pentest_state)."
fi


