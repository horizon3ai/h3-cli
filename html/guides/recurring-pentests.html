<!DOCTYPE html>
<html  dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.26.4/css/uikit.gradient.css">

        <!-- <link rel="stylesheet" href="style.css"> -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/style.css">
        <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
        <!-- <script src="uikit.js"></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/uikit.js"></script>
        <!-- <script src="scripts.js"></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/scripts.js"></script>
        <!-- <script src="jquery.sticky-kit.js "></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/jquery.sticky-kit.js"></script>

        <meta name="generator" content="pandoc-uikit" />
                        <title>recurring-pentests</title>
        <style type="text/css">code{white-space: pre;}</style>
                                                       
    </head>

    <body>


        <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">

            
            <div class="uk-grid" data-uk-grid-margin >          
                <div class="uk-width-medium-1-4">
                    <div class="uk-overflow-container" data-uk-sticky="{top:25,media: 768}">
                        <div class="uk-panel uk-panel-box menu-begin" >

                                                        <ul>
                                                        <li><a
                                                        href="#h3-cli-how-to-schedule-recurring-pentests-using-h3-cli-and-cron"
                                                        id="toc-h3-cli-how-to-schedule-recurring-pentests-using-h3-cli-and-cron">h3-cli:
                                                        How to schedule
                                                        recurring
                                                        pentests using
                                                        h3-cli and
                                                        cron</a></li>
                                                        <li><a
                                                        href="#run-a-pentest-via-cron"
                                                        id="toc-run-a-pentest-via-cron">Run
                                                        a pentest via
                                                        cron</a></li>
                                                        <li><a
                                                        href="#configure-timing-windows-for-active-pentesting"
                                                        id="toc-configure-timing-windows-for-active-pentesting">Configure
                                                        timing windows
                                                        for active
                                                        pentesting</a></li>
                                                        <li><a
                                                        href="#end-a-pentest"
                                                        id="toc-end-a-pentest">End
                                                        a
                                                        pentest</a></li>
                                                        <li><a
                                                        href="#common-cron-issues"
                                                        id="toc-common-cron-issues">Common
                                                        cron
                                                        issues</a></li>
                                                        </ul>
                            
                        </div>
                    </div>
                </div>

                <div class="uk-width-medium-3-4">

                    
<h2
id="h3-cli-how-to-schedule-recurring-pentests-using-h3-cli-and-cron">h3-cli:
How to schedule recurring pentests using h3-cli and cron</h2>
<p>You can wire up h3-cli to a job scheduler (eg. cron) in order to run
pentests on a recurring basis, for example once a week or once a month.
This guide shows you how to configure <strong>cron</strong> to
automatically kick off a pentest once a week.</p>
<p>cron is just one of many job scheduling services you could use for
this purpose. Any service is compatible with this guide as long as you
can invoke h3-cli from it.</p>
<p><strong>IMPORTANT:</strong> If you’re running <em>internal</em>
pentests, you have to download and run NodeZero as part of the cron job.
This means h3-cli must be installed and executed on the machine where
you intend to run NodeZero.</p>

<h2 id="run-a-pentest-via-cron">Run a pentest via cron</h2>
<p>The command <code>h3 run-pentest</code> will both (1) schedule the
pentest, and (2) launch NodeZero (if it’s an <em>internal</em> pentest;
for external pentests it skips the launch step). All we need to do is
wire up the command to cron in order to schedule and launch your pentest
on a recurring basis.</p>
<p>The commands below show how to conifgure cron to run
<code>h3 run-pentest</code> every Friday at 6PM.</p>
<ol type="1">
<li><p>Open crontab for editing:</p>
<pre class="shell"><code>crontab -e</code></pre>
<p>This will open a document (typically) in a <a
href="https://www.vim.org/">Vim</a> text editor that will either be
empty or will contain lines of text outlining the purpose/use of the
file you just opened, each beginning with a single <code>#</code>
sign:</p>
<figure>
<img src="../images/edit_crontab_header.png" alt="crontab example" />
<figcaption aria-hidden="true">crontab example</figcaption>
</figure>
<p>By convention, lines in this file beginning with a <code>#</code> are
interpreted as “comments” and are ignored.</p>
<p>A newcomer to Vim will notice that attempting to edit this file in
its current state won’t work. This is because Vim opens files in
<code>normal</code> mode by default, which doesn’t allow for direct text
editing. In order to actually edit this crontab file, we’ll need to
enter Vim’s <code>insert</code> mode.</p></li>
<li><p>Enter into Vim’s <code>insert</code> mode by pressing
<code>i</code>. After pressing <code>i</code>, you’ll notice that typing
regularly now actually inserts text.</p></li>
<li><p>Add the following line to the crontab file while in Vim’s
<code>insert</code> mode:</p>
<pre class="shell"><code>0 18 * * 5 . $HOME/.bash_profile; h3 run-pentest &gt;&gt; /tmp/cron.log 2&gt;&amp;1</code></pre>
<p>This line can seem daunting to someone who’s never seen a cron
expression before or is new to working in a terminal. We can break the
above line down into three distinct sections:</p>
<ol type="1">
<li><p><code>0 18 * * 5</code><br />
The first five columns of the line define a <a
href="https://docs.oracle.com/cd/E12058_01/doc/doc.1014/e12030/cron_expressions.htm">cron
expression</a>. A cron expression specifies the <em>schedule</em> for
running the given commands. Here, the first number specifies the
<code>minute</code>, the second number specifies the <code>hour</code>,
and the last number specifies the <code>day of the week</code> the given
commands will be run. So for this example, this cron expression
translates to: “<em>Run every Friday at 6PM.</em>”</p></li>
<li><p><code>. $HOME/.bash_profile; h3 run-pentest</code><br />
There are the commands that the cron will <em>execute</em>. The first
command, <code>. $HOME/.bash_profile</code> will load the environment
variables and other shell configuration defined in
<code>$HOME/.bash_profile</code>. This is where you defined
<code>H3_CLI_HOME</code> and added it to the <code>PATH</code> when you
installed h3-cli. The second command runs <code>h3 run-pentest</code>,
which will schedule and launch the pentest.</p>
<ul>
<li><p><strong>DON’T FORGET THE DOT!</strong> The <code>.</code> command
is equivalent to <code>source</code>. It modifies the current
environment with the settings read from
<code>$HOME/.bash_profile</code>.</p></li>
<li><p>Note that on your system you may have used
<code>$HOME/.bashrc</code> or <code>$HOME/.profile</code> instead of
<code>$HOME/.bash_profile</code>, in which case substitute the file you
used in the crontab command.</p></li>
<li><p>There are several ways to specify additional parameters when
scheduling pentests. For more information see additional examples <a
href="../README.html#scheduling-and-running-pentests-with-h3-cli">here</a>.</p></li>
</ul></li>
<li><p><code>&gt;&gt; /tmp/cron.log 2&gt;&amp;1</code><br />
This redirects the output of the executed commands to a specific file on
your filesystem.</p></li>
</ol>
<p>So the line we just inserted will cause cron to wake up every Friday
at 6PM, run the given shell commands, and write the output to
<code>/tmp/cron.log</code>.</p></li>
<li><p>Save your changes and exit the text editor. For Vim, this
requires two quick steps:</p>
<ol type="1">
<li>Press <code>esc</code> to exit <code>insert</code> mode and return
back to <code>normal</code> mode.</li>
<li>In <code>normal</code> mode, type: <code>:wq</code>
(<strong>w</strong>rite and <strong>q</strong>uit) to save your changes
and exit.</li>
</ol>
<p>If everything worked, you should see something like
<code>crontab: installing new crontab</code> as output.</p></li>
</ol>
<p>For a quick reference on configuring cron jobs, see <a
href="https://www.adminschoice.com/crontab-quick-reference">this
article</a>. To verify the schedule for a given cron expression, check
out <a href="https://crontab.guru/">this site</a>.</p>
<h2 id="configure-timing-windows-for-active-pentesting">Configure timing
windows for active pentesting</h2>
<p>You may wish to pause and resume your pentest, for example around
business hours, in order to minimize any chance of disruption to your
daily work.</p>
<p>In this example we’ll wire up <code>h3 pause-pentest</code> and
<code>h3 resume-pentest</code> to cron such that the pentest is paused
at the beginning of the work day (9AM) and resumed at the end of the
work day (5PM).</p>
<p>Add the following lines to your crontab (via <code>crontab -e</code>
):</p>
<pre class="shell"><code>0 9 * * 1-5 . $HOME/.bash_profile; h3 pause-pentest &gt;&gt;/tmp/cron.log 2&gt;&amp;1
0 17 * * 1-5 . $HOME/.bash_profile; h3 resume-pentest &gt;&gt;/tmp/cron.log 2&gt;&amp;1</code></pre>
<p>This schedule will run <code>h3 pause-pentest</code> every weekday
(Mon-Fri) at 9AM and <code>h3 resume-pentest</code> every weekday at
5PM.</p>
<h2 id="end-a-pentest">End a pentest</h2>
<p>Perhaps you only want the pentest to run over the weekend and if it’s
still running on Monday morning, you’d want to end it and view the
results.</p>
<p>This can be done by wiring up <code>h3 cancel-pentest</code> to
cron:</p>
<pre class="shell"><code>0 8 * * 1 . $HOME/.bash_profile; h3 cancel-pentest &gt;&gt;/tmp/cron.log  2&gt;&amp;1</code></pre>
<p>This schedule will run <code>h3 cancel-pentest</code> on Mondays at
8AM.</p>
<blockquote>
<p><em>Canceling</em> a pentest will fully shut it down. The results of
the pentest are still recorded, up to the time it is canceled, and will
be reported in Portal. <strong>None</strong> of the pentest’s data is
deleted/purged in any way.</p>
</blockquote>
<h2 id="common-cron-issues">Common cron issues</h2>
<h4 id="error-sysctl-command-not-found">ERROR: sysctl: command not
found</h4>
<p>A common issue you might encounter is the <code>PATH</code>
environment variable used by cron is different than your login session,
in which case it may not be able to find certain commands, eg. sysctl.
You can fix this by setting the <code>PATH</code> directly in the
crontab entry:</p>
<pre class="shell"><code>0 18 * * 5 export PATH=$PATH:/usr/local/bin:/usr/sbin; . $HOME/.bash_profile; h3 run-pentest &gt;&gt;/tmp/cron.log 2&gt;&amp;1</code></pre>
<h4
id="error-authentication-failed.-please-make-sure-the-token-is-still-valid.">ERROR:
Authentication failed. Please make sure the token is still valid.</h4>
<p>This usually means Docker was unable to store the credentials it uses
to log in to the Docker registry containing the image for NodeZero.</p>
<p>On MacOS, this can usually be corrected by removing
<code>"credsStore": "desktop"</code> or
<code>"credsStore": "osxkeychain"</code> from your Docker
<code>config.json</code> , which is typically found at
<code>$HOME/.docker/config.json</code> .</p>
<p>For other operating systems, you may need to remove
<code>$HOME/.docker/config.json</code> entirely, and restart Docker. For
more information about the error, search: “Docker Error saving
credentials: error storing credentials - err: exit status 1, out: Write
permissions error”</p>
<h4 id="error-the-path-is-not-shared-and-is-not-known-to-docker.">ERROR:
The path is not shared and is not known to Docker.</h4>
<p>Based on your Docker configuration, you may need to run NodeZero in a
specific directory where Docker has permission to mount volumes to the
host filesystem. By default cron launches jobs within the
<code>$HOME</code> directory.</p>
<p>To run a cron job in a different directory, simply <code>cd</code> to
that directory in the crontab entry.</p>
<pre class="shell"><code>0 18 * * 5 cd /run/from/here; . $HOME/.bash_profile; h3 run-pentest  &gt;&gt;/tmp/cron.log 2&gt;&amp;1</code></pre>
<h4 id="killing-a-cron-job">Killing a cron job</h4>
<p>A cron job ends when the command(s) it executes ends. If you have a
“runaway” cron job, you can terminate it by killing the process it
started.</p>
<p>To kill a process started by cron , you must find it using
<code>ps</code> and then <code>kill</code> it:</p>
<pre class="shell"><code>ps aux | grep start_pentest     # find the PID
kill -9 {pid}</code></pre>
<blockquote>
<p><code>ps</code> arguments vary by system.</p>
</blockquote>                    
                </div>
            </div>
            <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>
        </div>
    </body>
</html>
