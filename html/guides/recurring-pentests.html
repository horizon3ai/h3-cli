<!DOCTYPE html>
<html  dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.26.4/css/uikit.gradient.css">

        <!-- <link rel="stylesheet" href="style.css"> -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/style.css">
        <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
        <!-- <script src="uikit.js"></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/uikit.js"></script>
        <!-- <script src="scripts.js"></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/scripts.js"></script>
        <!-- <script src="jquery.sticky-kit.js "></script> -->
        <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-uikit@master/jquery.sticky-kit.js"></script>

        <meta name="generator" content="pandoc-uikit" />
                        <title>recurring-pentests</title>
        <style type="text/css">code{white-space: pre;}</style>
                                                       
    </head>

    <body>


        <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">

            
            <div class="uk-grid" data-uk-grid-margin >          
                <div class="uk-width-medium-1-4">
                    <div class="uk-overflow-container" data-uk-sticky="{top:25,media: 768}">
                        <div class="uk-panel uk-panel-box menu-begin" >

                                                        <ul>
                                                        <li><a
                                                        href="#h3-cli-how-to-run-recurring-pentests-automatically-using-h3-cli"
                                                        id="toc-h3-cli-how-to-run-recurring-pentests-automatically-using-h3-cli">h3-cli:
                                                        How to run
                                                        recurring
                                                        pentests
                                                        automatically
                                                        using h3-cli</a>
                                                        <ul>
                                                        <li><a
                                                        href="#spin-up-an-h3-cli-agent-internal-pentests-only"
                                                        id="toc-spin-up-an-h3-cli-agent-internal-pentests-only">1.
                                                        Spin up an
                                                        h3-cli agent
                                                        (<em>internal</em>
                                                        pentests
                                                        only)</a></li>
                                                        <li><a
                                                        href="#create-a-scheduled-action-to-run-a-pentest-on-a-recurring-schedule"
                                                        id="toc-create-a-scheduled-action-to-run-a-pentest-on-a-recurring-schedule">2.
                                                        Create a
                                                        scheduled action
                                                        to run a pentest
                                                        on a recurring
                                                        schedule</a></li>
                                                        <li><a
                                                        href="#verify-your-schedule-is-registered-with-h3"
                                                        id="toc-verify-your-schedule-is-registered-with-h3">3.
                                                        Verify your
                                                        schedule is
                                                        registered with
                                                        H3</a></li>
                                                        <li><a
                                                        href="#test-your-scheduled-action-by-triggering-it-now"
                                                        id="toc-test-your-scheduled-action-by-triggering-it-now">4.
                                                        Test your
                                                        scheduled action
                                                        by triggering it
                                                        now</a></li>
                                                        <li><a
                                                        href="#troubleshooting"
                                                        id="toc-troubleshooting">5.
                                                        Troubleshooting</a></li>
                                                        <li><a
                                                        href="#create-a-second-scheduled-action-to-cancel-the-pentest-optional"
                                                        id="toc-create-a-second-scheduled-action-to-cancel-the-pentest-optional">6.
                                                        Create a second
                                                        scheduled action
                                                        to cancel the
                                                        pentest
                                                        (optional)</a></li>
                                                        </ul></li>
                                                        <li><a
                                                        href="#enabling-and-disabling-a-schedule"
                                                        id="toc-enabling-and-disabling-a-schedule">Enabling
                                                        and disabling a
                                                        schedule</a></li>
                                                        <li><a
                                                        href="#configuring-pentesting-windows"
                                                        id="toc-configuring-pentesting-windows">Configuring
                                                        pentesting
                                                        windows</a></li>
                                                        <li><a
                                                        href="#updating-and-deleting-scheduled-actions"
                                                        id="toc-updating-and-deleting-scheduled-actions">Updating
                                                        and deleting
                                                        scheduled
                                                        actions</a></li>
                                                        <li><a
                                                        href="#creating-multiple-schedules"
                                                        id="toc-creating-multiple-schedules">Creating
                                                        multiple
                                                        schedules</a></li>
                                                        </ul>
                            
                        </div>
                    </div>
                </div>

                <div class="uk-width-medium-3-4">

                    
<h2
id="h3-cli-how-to-run-recurring-pentests-automatically-using-h3-cli">h3-cli:
How to run recurring pentests automatically using h3-cli</h2>
<p>The instructions below walk through how to use h3-cli to configure a
recurring schedule for running pentests automatically on a regular
basis.</p>
<h3 id="spin-up-an-h3-cli-agent-internal-pentests-only">1. Spin up an
h3-cli agent (<em>internal</em> pentests only)</h3>
<p>If you plan to run <em>internal</em> pentests (which is the default),
you will need to spin up a persistent agent process on the Docker Host
inside your network where you plan to run NodeZero.</p>
<p>The h3-cli agent is a long-lived daemon process that periodically
polls the H3 API and automatically launches NodeZero on the local
machine whenever a new pentest is created and assigned to that
agent.</p>
<blockquote>
<p>If you are running <em>external</em> pentests, the agent is not
required and you can skip this step.</p>
</blockquote>
<p>Follow the instructions in <a
href="touchless-nodezero.html"><strong>STEP 1</strong> of this guide</a>
to spin up an agent using h3-cli. You can ignore all the other steps in
that guide; only step 1 is required.</p>
<h3
id="create-a-scheduled-action-to-run-a-pentest-on-a-recurring-schedule">2.
Create a scheduled action to run a pentest on a recurring schedule</h3>
<p>The command below will create a recurring schedule called
<code>my-schedule</code> that will automatically run a pentest every
Monday at 5pm UTC.</p>
<pre class="shell"><code>h3 create-scheduled-action my-schedule &#39;0 17 * * 1&#39; run-pentest &#39;{&quot;agent_name&quot;: &quot;my-agent&quot;, &quot;op_name&quot;: &quot;Scheduled via agent&quot;}&#39;</code></pre>
<p>The command uses a <a href="https://crontab.guru/">CRON
expression</a>, <code>0 17 * * 1</code>, to specify the recurring
schedule for the pentest.</p>
<p>Breaking it down:</p>
<ul>
<li><code>my-schedule</code> is the name of the schedule. A schedule may
contain multiple actions. For example you can configure timing windows
for pentesting around by business hours, by scheduling a pentest to
launch on Monday at 5pm, pause every day at 8am, resume at 5pm, and
finally terminate on Friday if it still running.</li>
<li><code>0 17 * * 1</code> is the <a href="https://crontab.guru/">CRON
expression</a>. CRON expressions specify the
<code>{minute} {hour} {day-of-month} {month} {day-of-week}</code> to run
a given action. Visit the [link]((https://crontab.guru/) for more
information about CRON expressions.
<ul>
<li><strong>NOTE:</strong> Only hourly resolution is supported. The
<code>{minute}</code> component of the CRON expression is always forced
to be <code>0</code> on the backend.</li>
<li>CRON expressions are in <strong>UTC</strong> time. So the example
CRON expression above is set to <strong>5pm UTC</strong>.</li>
</ul></li>
<li><code>run-pentest</code> is the action. Supported actions are:
<ul>
<li><code>run-pentest</code>: launches a new pentest (if one is not
currently active for this schedule)</li>
<li><code>pause-pentest</code>: pauses the active pentest associated
with the schedule</li>
<li><code>resume-pentest</code>: resumes the active pentest associated
with the schedule</li>
<li><code>cancel-pentest</code>: cancel the active pentest associated
with the schedule</li>
</ul></li>
<li><code>'{"agent_name": "my-agent"}'</code>: additional parameters for
the <code>run-pentest</code> action. These parameters are the same as
those you would use if you executed <code>h3 run-pentest</code> directly
from the command line.</li>
</ul>
<p>A named schedule can have <strong>only one active pentest at a
time</strong>. This prevents a schedule from kicking off a new pentest
when its previous pentest has not yet completed.</p>
<h3 id="verify-your-schedule-is-registered-with-h3">3. Verify your
schedule is registered with H3</h3>
<p>Use the following command to view your pentest schedules:</p>
<pre class="shell"><code>h3 schedules</code></pre>
<p>If all is well, you should see an entry for your schedule
<code>my-schedule</code>.</p>
<h3 id="test-your-scheduled-action-by-triggering-it-now">4. Test your
scheduled action by triggering it now</h3>
<p>To ensure everything is wired up as expected, you can trigger your
scheduled action immediately with the following command:</p>
<pre class="shell"><code>h3 trigger-scheduled-action my-schedule run-pentest </code></pre>
<p>This will trigger the <code>run-pentest</code> action for the
<code>my-schedule</code> schedule, which will cause a pentest to be
created. The agent running on your NodeZero Docker Host will see the new
pentest and automatically run NodeZero.</p>
<p>You can monitor the agent process by tailing the log:</p>
<pre class="shell"><code>tail -f /tmp/my-agent.log</code></pre>
<p>In a minute or so you should see the agent kick off the NodeZero
Launch Script for the newly created pentest. The NodeZero Launch Script
will download and launch the NodeZero Docker container on the local
machine, just as if you had copy+pasted the <code>curl</code> command
from the H3 Web Portal.</p>
<p>You can view the newly created pentest via:</p>
<pre class="shell"><code>h3 pentest </code></pre>
<p>Side note: If for whatever reason you need to kill the NodeZero
Launch Script before it downloads and launches NodeZero, you can use
<code>pkill</code>:</p>
<pre class="shell"><code>pkill -f h3-run-nodezero</code></pre>
<p>Once the NodeZero Docker container is running, you can manage its
lifecycle via the Docker API.</p>
<h3 id="troubleshooting">5. Troubleshooting</h3>
<p>If you don’t see NodeZero get launched in the agent log, use
<code>h3 schedules</code> to see if any errors occurred when the action
was triggered:</p>
<pre class="shell"><code>h3 schedules</code></pre>
<p>The command output will resemble the readout below. Look at the
<code>last_triggered_*</code> fields to help diagnose any problems:</p>
<pre class="shell"><code>{
  &quot;name&quot;: &quot;my-schedule&quot;,
  &quot;state&quot;: &quot;ENABLED&quot;,
  &quot;created_at&quot;: &quot;2023-02-06T06:52:04.660895&quot;,
  &quot;last_updated_at&quot;: &quot;2023-02-10T23:16:36.722392&quot;,
  &quot;actions&quot;: [
    {
      &quot;action&quot;: &quot;run-pentest&quot;,
      &quot;params&quot;: {
        &quot;agent_name&quot;: &quot;my-agent&quot;,
        &quot;op_name&quot;: &quot;Scheduled via agent&quot;
      },
      &quot;cron_expression&quot;: &quot;0 17 * * 1&quot;,
      &quot;cron_description&quot;: &quot;At 05:00 PM, only on Monday&quot;,
      &quot;last_triggered_at&quot;: &quot;2023-02-10T22:08:05.010069&quot;,
      &quot;last_triggered_time_ago&quot;: &quot;an hour ago&quot;,
      &quot;last_triggered_error&quot;: null
    }
  ]
}</code></pre>
<p>For further assistance, contact H3 support via the chat icon in the
<a href="https://portal.horizon3ai.com/">H3 Web Portal</a>.</p>
<h3
id="create-a-second-scheduled-action-to-cancel-the-pentest-optional">6.
Create a second scheduled action to cancel the pentest (optional)</h3>
<p>Let’s add a second action to our schedule for canceling the pentest.
We’ll schedule it to run 1hr after the pentest is launched.</p>
<pre class="shell"><code>h3 create-scheduled-action my-schedule &#39;0 18 * * 1&#39; cancel-pentest</code></pre>
<p>Once again we can test the action by triggering it immediately:</p>
<pre class="shell"><code>h3 trigger-scheduled-action my-schedule cancel-pentest </code></pre>
<p>After a moment you should see your pentest get canceled and move into
the post-processing state.</p>
<h2 id="enabling-and-disabling-a-schedule">Enabling and disabling a
schedule</h2>
<p>You can view all of your schedules via:</p>
<pre class="shell"><code>h3 schedules</code></pre>
<p>You can disable a schedule and all its actions via
<code>disable-schedule</code>:</p>
<pre class="shell"><code>h3 disable-schedule my-schedule</code></pre>
<p>And you can re-enable a schedule via
<code>enable-schedule</code>:</p>
<pre class="shell"><code>h3 enable-schedule my-schedule</code></pre>
<h2 id="configuring-pentesting-windows">Configuring pentesting
windows</h2>
<p>You can use scheduled actions to pause and resume pentests around
pentesting windows, eg. around business hours. The commands below show
how to create a schedule that will:</p>
<ul>
<li>launch pentests on Mondays at 5pm UTC</li>
<li>pause the running pentest every weekday at 8am UTC</li>
<li>resume the paused pentest every weekday at 5pm UTC</li>
<li>cancel the pentest if it’s still running on Friday at 8am UTC</li>
</ul>
<pre class="shell"><code>h3 create-scheduled-action my-schedule &#39;0 17 * * 1&#39; run-pentest &#39;{&quot;agent_name&quot;: &quot;my-agent&quot;, &quot;op_name&quot;: &quot;Scheduled via agent&quot;}&#39;
h3 create-scheduled-action my-schedule &#39;0 8 * * 2-4&#39; pause-pentest 
h3 create-scheduled-action my-schedule &#39;0 17 * * 2-4&#39; resume-pentest 
h3 create-scheduled-action my-schedule &#39;0 8 * * 5&#39; cancel-pentest </code></pre>
<h2 id="updating-and-deleting-scheduled-actions">Updating and deleting
scheduled actions</h2>
<p>You can update a scheduled action by simply running the
<code>create-scheduled-action</code> again with the new settings. For
example, if you wish to change the schedule above such that it cancels
the pentest at 7am UTC instead of 8am:</p>
<pre class="shell"><code>h3 create-scheduled-action my-schedule &#39;0 7 * * 5&#39; cancel-pentest </code></pre>
<p>Or if you wish to delete a scheduled action, use the
<code>delete-scheduled-action</code> command:</p>
<pre class="shell"><code>h3 delete-scheduled-action my-schedule cancel-pentest</code></pre>
<h2 id="creating-multiple-schedules">Creating multiple schedules</h2>
<p>You can create multiple schedules by simply using a different
schedule name. For example, here’s a separate schedule named
<code>my-weekend-schedule</code> that launches a pentest on Friday at
5pm UTC and cancels it Monday at 8am UTC:</p>
<pre class="shell"><code>h3 create-scheduled-action my-weekend-schedule &#39;0 17 * * 5&#39; run-pentest &#39;{&quot;agent_name&quot;: &quot;my-agent&quot;, &quot;op_name&quot;: &quot;Weekend Pentest&quot;}&#39;
h3 create-scheduled-action my-weekend-schedule &#39;0 8 * * 1&#39; cancel-pentest </code></pre>                    
                </div>
            </div>
            <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>
        </div>
    </body>
</html>
